// chapters.js
const CHAPTERS=[
{id:0,title:'序章',subtitle:'墜落之夜',objective:'seize',objectiveDesc:'艾琳到達出口',seizePos:{x:7,y:4},width:8,height:6,
terrain:['WWWWWWWW','WPPPWPPW','WPWPPPPW','WPPPWPPW','WPPPPPPG','WWWWWWWW'],
playerUnits:[{charId:'eirine',x:1,y:2},{charId:'marcus',x:1,y:3}],
enemies:[
{classId:'soldier',level:1,x:4,y:1,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:1,x:5,y:2,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:1,x:6,y:3,items:['ironLance'],ai:'defensive',name:'帝國兵'},
{classId:'soldier',level:2,x:6,y:1,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:1,x:3,y:4,items:['ironLance'],ai:'aggressive',name:'帝國兵'}],
npcs:[],newRecruits:[],talkEvents:[],turnEvents:[],
dialogues:{pre:[
{speaker:'eirine',text:'父王……不！我不能離開你！'},
{speaker:null,text:'國王將星印交到艾琳手中——'},
{speaker:'marcus',text:'殿下，我們必須離開！宰相的軍隊已經攻入了！'},
{speaker:'eirine',text:'……我明白了。馬庫斯，帶我衝出去！'}],
post:[
{speaker:'eirine',text:'我們逃出來了……但父王他……'},
{speaker:'marcus',text:'殿下，先王將一切託付給了您。我們必須活下去。'},
{speaker:'eirine',text:'……是的。我會變強的。為了父王，為了帝國。'}]}},

{id:1,title:'第一章',subtitle:'荒野的邂逅',objective:'rout',objectiveDesc:'殲滅所有敵人',width:12,height:10,
terrain:['PPFFPPPPFFPP','PPFPPPPPFPPP','PPPPPFFPPPPP','FFPPPPPPPPFF','PPPPPPPPPPPP','PPPFFFPPPPPP','PPPPFPPPPPPP','PPPPPPPPFFPP','PPPPPPPPFPPP','PPPPPPPPPPPP'],
playerUnits:[{charId:'eirine',x:1,y:4},{charId:'marcus',x:0,y:5}],
newRecruits:[{charId:'lina',x:3,y:2,turnJoin:1}],
enemies:[
{classId:'soldier',level:2,x:8,y:1,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:2,x:9,y:2,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:2,x:10,y:3,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:3,x:10,y:5,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'fighter',level:2,x:9,y:6,items:['ironAxe'],ai:'aggressive',name:'傭兵'},
{classId:'fighter',level:2,x:8,y:7,items:['ironAxe'],ai:'aggressive',name:'傭兵'},
{classId:'archer',level:2,x:11,y:4,items:['ironBow'],ai:'defensive',name:'弓兵'},
{classId:'soldier',level:3,x:10,y:8,items:['ironLance'],ai:'aggressive',name:'隊長'}],
npcs:[],talkEvents:[],
turnEvents:[{turn:1,type:'recruit',text:[{speaker:'lina',text:'追兵來了！我來幫你們！'}]}],
dialogues:{pre:[
{speaker:'marcus',text:'殿下，前方有追兵的蹤跡。'},
{speaker:'lina',text:'喂，你們是被帝國追殺的人吧？我叫莉娜，獵人。'}],
post:[{speaker:'lina',text:'解決了。反正我也沒地方去了。走吧。'}]}},

{id:2,title:'第二章',subtitle:'北境之村',objective:'survive',objectiveDesc:'堅持8回合',surviveTurns:8,width:14,height:12,
terrain:['MMPPPPPPPPPPFM','MPPPPPPPPPPPFM','PPPPVPPVPPPPPP','PPPPPPPPPPPPPP','PPPPPPPPPFPPPP','PPPPPPPPFFPPPP','PPPPVPPPPPPPPP','PPPPPPPPPPPPPP','PPPPPPPPPPPPPP','RRRRRRRRRRRRPP','PPPPPPPPPPPPPP','MMPPPPPPPPPPFM'],
playerUnits:[{charId:'eirine',x:6,y:4},{charId:'marcus',x:5,y:4},{charId:'lina',x:7,y:4}],
newRecruits:[{charId:'thor',x:4,y:6,turnJoin:1},{charId:'serra',x:5,y:6,turnJoin:1}],
enemies:[
{classId:'brigand',level:3,x:0,y:0,items:['ironAxe'],ai:'aggressive',name:'山賊'},
{classId:'brigand',level:3,x:1,y:0,items:['ironAxe'],ai:'aggressive',name:'山賊'},
{classId:'brigand',level:4,x:13,y:0,items:['ironAxe'],ai:'aggressive',name:'山賊'},
{classId:'brigand',level:3,x:13,y:1,items:['ironAxe'],ai:'aggressive',name:'山賊'}],
npcs:[],talkEvents:[],
turnEvents:[
{turn:1,type:'recruit',text:[{speaker:'thor',text:'看我的斧頭！山賊們，受死吧！'},{speaker:'serra',text:'我會治療大家的傷勢！'}]},
{turn:3,type:'reinforce',enemies:[
{classId:'brigand',level:3,x:0,y:11,items:['ironAxe'],ai:'aggressive',name:'山賊'},
{classId:'brigand',level:4,x:1,y:11,items:['steelAxe'],ai:'aggressive',name:'山賊頭目'},
{classId:'brigand',level:3,x:13,y:11,items:['ironAxe'],ai:'aggressive',name:'山賊'}]},
{turn:5,type:'reinforce',enemies:[
{classId:'brigand',level:4,x:0,y:0,items:['steelAxe'],ai:'aggressive',name:'山賊'},
{classId:'brigand',level:4,x:13,y:0,items:['handAxe'],ai:'aggressive',name:'山賊'},
{classId:'fighter',level:5,x:0,y:11,items:['steelAxe'],ai:'aggressive',name:'山賊頭領'}]}],
dialogues:{pre:[
{speaker:'eirine',text:'前方的村莊正在遭受山賊攻擊！'},
{speaker:'thor',text:'喂！你們是來幫忙的嗎？我叫托爾！'},
{speaker:'serra',text:'請幫幫我們……我是賽拉。'}],
post:[{speaker:'thor',text:'哈哈！打得痛快！算我一個！'},{speaker:'serra',text:'殿下……請讓我跟隨您。'}]}},

{id:3,title:'第三章',subtitle:'傭兵的代價',objective:'rout',objectiveDesc:'說服凱恩並殲滅敵人',width:12,height:10,
terrain:['MMPPPPPPMMPP','MPPPPPPPMPPP','PPPPRRPPPPPP','PPPPRRPPPPPP','PPPPRPPPPPPP','PPPGGGPPPPPP','PPPPPPPPPPPP','PPPPPPPPPPPP','PPPPPPPPPPPP','PPPPPPPPPPPP'],
playerUnits:[{charId:'eirine',x:1,y:8},{charId:'marcus',x:0,y:8},{charId:'lina',x:2,y:9},{charId:'thor',x:1,y:9},{charId:'serra',x:0,y:9}],
newRecruits:[],
enemies:[
{classId:'mercenary',level:5,x:6,y:1,items:['ironSword'],ai:'aggressive',name:'凱恩',isCain:true,recruitableBy:'eirine'},
{classId:'soldier',level:4,x:8,y:0,items:['ironLance'],ai:'aggressive',name:'傭兵團員'},
{classId:'soldier',level:4,x:9,y:1,items:['ironLance'],ai:'aggressive',name:'傭兵團員'},
{classId:'fighter',level:4,x:10,y:2,items:['ironAxe'],ai:'aggressive',name:'傭兵團員'},
{classId:'fighter',level:4,x:10,y:3,items:['ironAxe'],ai:'aggressive',name:'傭兵團員'},
{classId:'archer',level:4,x:11,y:1,items:['ironBow'],ai:'defensive',name:'傭兵弓手'},
{classId:'soldier',level:5,x:7,y:3,items:['steelLance'],ai:'aggressive',name:'傭兵隊長'},
{classId:'soldier',level:4,x:9,y:5,items:['ironLance'],ai:'aggressive',name:'傭兵團員'},
{classId:'fighter',level:4,x:8,y:6,items:['ironAxe'],ai:'aggressive',name:'傭兵團員'},
{classId:'soldier',level:4,x:11,y:5,items:['ironLance'],ai:'aggressive',name:'傭兵團員'}],
npcs:[],
talkEvents:[{from:'eirine',target:'cain',dialogue:[
{speaker:'eirine',text:'凱恩！你不必為帝國賣命！'},
{speaker:'cain',text:'……哦？公主殿下想說什麼？'},
{speaker:'eirine',text:'和我一起戰鬥吧。'},
{speaker:'cain',text:'…有意思。好吧，就陪你玩玩。'}]}],
turnEvents:[],
dialogues:{pre:[
{speaker:'marcus',text:'殿下，前方峽谷有一隊傭兵擋路。'},
{speaker:'eirine',text:'也許我可以說服那個領頭的。'}],
post:[{speaker:'cain',text:'哼，正義可不能當飯吃。不過……算了，我跟你走。'}]}},

{id:4,title:'第四章',subtitle:'魔法塔',objective:'seize',objectiveDesc:'艾琳到達塔頂',seizePos:{x:4,y:0},width:10,height:14,
terrain:['WWWWGWWWWW','WPPPPPPPWW','WPWWPPWWPW','WPPPPPPPWW','WWPPWWPPWW','WPPPPPPPWW','WPWWPPWWPW','WPPPPPPPWW','WWPPWWPPWW','WPPPPPPPWW','WPWWPPWWPW','WPPPPPPPWW','WPPPPPPPWW','WWWWGWWWWW'],
playerUnits:[{charId:'eirine',x:4,y:13},{charId:'marcus',x:3,y:12},{charId:'lina',x:5,y:12},{charId:'thor',x:4,y:12},{charId:'serra',x:5,y:11},{charId:'cain',x:3,y:11}],
newRecruits:[{charId:'fran',x:5,y:1,turnJoin:1}],
enemies:[
{classId:'mage',level:6,x:3,y:3,items:['fire'],ai:'defensive',name:'魔法師'},
{classId:'mage',level:6,x:7,y:3,items:['thunder'],ai:'defensive',name:'魔法師'},
{classId:'mage',level:6,x:3,y:5,items:['wind'],ai:'defensive',name:'魔法師'},
{classId:'mage',level:7,x:7,y:5,items:['fire'],ai:'aggressive',name:'魔法師'},
{classId:'skeleton',level:5,x:1,y:7,items:['ironLance'],ai:'aggressive',name:'骷髏兵'},
{classId:'skeleton',level:5,x:8,y:7,items:['ironAxe'],ai:'aggressive',name:'骷髏兵'},
{classId:'mage',level:7,x:3,y:9,items:['elfire'],ai:'defensive',name:'上級魔法師'},
{classId:'mage',level:7,x:7,y:9,items:['elthunder'],ai:'defensive',name:'上級魔法師'},
{classId:'mage',level:7,x:1,y:11,items:['fire'],ai:'aggressive',name:'魔法師'},
{classId:'mage',level:7,x:8,y:11,items:['thunder'],ai:'aggressive',name:'魔法師'},
{classId:'darkMage',level:8,x:4,y:1,items:['flux'],ai:'boss',name:'暗黑祭司',isBoss:true},
{classId:'skeleton',level:6,x:2,y:1,items:['ironAxe'],ai:'defensive',name:'骷髏兵'}],
npcs:[],talkEvents:[],
turnEvents:[{turn:1,type:'recruit',text:[{speaker:'fran',text:'讓本天才來幫你們吧！'}]}],
dialogues:{pre:[
{speaker:'eirine',text:'這就是傳說中的魔法塔……'},
{speaker:'fran',text:'哈哈哈！你們是誰？'}],
post:[{speaker:'fran',text:'不錯嘛。帶我去見見世面吧！'}]}},

{id:5,title:'最終章',subtitle:'翠星之戰',objective:'boss',objectiveDesc:'擊敗莫爾甘',width:16,height:14,
terrain:['WWWWWWWGWWWWWWWW','WWPPPPPPPPPPPWWW','WPPPPPPPPPPPPPWW','WPPPWWPPWWPPPPPW','PPPPPPPPPPPPPPPW','PPPPPPPPPPPPPPPP','PPPPPPPPPPPPPPPP','PPPPFFPPPPFFPPPP','PPPPFFPPPPFFPPPP','PPPPPPPPPPPPPPPP','PPPPPPPPPPPPPPPP','PPFFFPPPPPFFFPPP','PPPPPPPPPPPPPPPP','PPPPPPPPPPPPPPPP'],
playerUnits:[{charId:'eirine',x:7,y:13},{charId:'marcus',x:6,y:13},{charId:'lina',x:8,y:13},{charId:'thor',x:6,y:12},{charId:'serra',x:8,y:12},{charId:'cain',x:7,y:12},{charId:'fran',x:9,y:12}],
newRecruits:[{charId:'rex',x:12,y:10,turnJoin:2}],
enemies:[
{classId:'knight',level:8,x:5,y:5,items:['steelLance'],ai:'aggressive',name:'近衛兵'},
{classId:'knight',level:8,x:10,y:5,items:['steelLance'],ai:'aggressive',name:'近衛兵'},
{classId:'soldier',level:7,x:3,y:6,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'soldier',level:7,x:12,y:6,items:['ironLance'],ai:'aggressive',name:'帝國兵'},
{classId:'archer',level:7,x:7,y:6,items:['steelBow'],ai:'defensive',name:'帝國弓兵'},
{classId:'fighter',level:7,x:4,y:8,items:['steelAxe'],ai:'aggressive',name:'帝國戰士'},
{classId:'fighter',level:7,x:11,y:8,items:['steelAxe'],ai:'aggressive',name:'帝國戰士'},
{classId:'mage',level:8,x:6,y:4,items:['elfire'],ai:'defensive',name:'帝國魔法師'},
{classId:'mage',level:8,x:9,y:4,items:['elthunder'],ai:'defensive',name:'帝國魔法師'},
{classId:'soldier',level:8,x:3,y:3,items:['steelLance'],ai:'defensive',name:'近衛兵'},
{classId:'soldier',level:8,x:12,y:3,items:['steelLance'],ai:'defensive',name:'近衛兵'},
{classId:'knight',level:9,x:6,y:2,items:['silverLance'],ai:'defensive',name:'精銳近衛'},
{classId:'knight',level:9,x:9,y:2,items:['silverLance'],ai:'defensive',name:'精銳近衛'},
{classId:'mage',level:9,x:7,y:1,items:['elfire'],ai:'defensive',name:'宮廷魔法師'},
{classId:'soldier',level:8,x:8,y:2,items:['javelin'],ai:'defensive',name:'近衛兵'},
{classId:'darkMage',level:15,x:7,y:0,items:['eclipse','nosferatu'],ai:'boss',name:'莫爾甘',isBoss:true,bonusStats:{hp:15,mag:5,skl:5,spd:3,lck:5,def:5,res:5}}],
npcs:[],talkEvents:[],
turnEvents:[{turn:2,type:'recruit',text:[{speaker:'rex',text:'艾琳殿下！飛龍騎士團來支援了！'}]}],
dialogues:{pre:[
{speaker:'eirine',text:'帝都……我終於回來了。今天，我們要奪回這個國家！'},
{speaker:'marcus',text:'這是最後的戰鬥了。'}],
post:[
{speaker:'eirine',text:'結束了……莫爾甘。'},
{speaker:null,text:'翠星之光消散，六枚星印重歸安寧——'},
{speaker:'eirine',text:'父王……我做到了。'},
{speaker:null,text:'—— 火炎之紋章：翠星之影 ——  完 ——'}]}}
];

const CHARACTERS={
eirine:{name:'艾琳',classId:'lord',level:1,isLord:true,portrait:{hair:'#c4a',eyes:'#48f',skin:'#fdb'},baseStats:{hp:18,str:5,mag:1,skl:5,spd:7,lck:6,def:4,res:1},growths:{hp:70,str:45,mag:15,skl:45,spd:55,lck:50,def:30,res:25},items:['rapier']},
marcus:{name:'馬庫斯',classId:'paladin',level:1,portrait:{hair:'#666',eyes:'#432',skin:'#eca'},baseStats:{hp:28,str:10,mag:1,skl:12,spd:9,lck:8,def:9,res:6},growths:{hp:40,str:20,mag:5,skl:20,spd:15,lck:20,def:15,res:10},items:['steelSword','ironLance']},
lina:{name:'莉娜',classId:'archer',level:1,portrait:{hair:'#6c4',eyes:'#4a4',skin:'#fdb'},baseStats:{hp:17,str:5,mag:0,skl:7,spd:7,lck:4,def:3,res:1},growths:{hp:55,str:40,mag:5,skl:55,spd:55,lck:35,def:20,res:20},items:['ironBow']},
thor:{name:'托爾',classId:'fighter',level:3,portrait:{hair:'#d82',eyes:'#654',skin:'#dba'},baseStats:{hp:24,str:8,mag:0,skl:4,spd:4,lck:3,def:5,res:0},growths:{hp:80,str:55,mag:5,skl:30,spd:25,lck:25,def:35,res:10},items:['ironAxe','handAxe']},
serra:{name:'賽拉',classId:'cleric',level:2,portrait:{hair:'#ffa',eyes:'#88f',skin:'#fed'},baseStats:{hp:16,str:1,mag:5,skl:4,spd:6,lck:7,def:1,res:7},growths:{hp:45,str:5,mag:55,skl:30,spd:35,lck:45,def:10,res:55},items:['heal']},
cain:{name:'凱恩',classId:'mercenary',level:5,portrait:{hair:'#444',eyes:'#a44',skin:'#dba'},baseStats:{hp:22,str:8,mag:0,skl:9,spd:10,lck:5,def:6,res:1},growths:{hp:65,str:45,mag:5,skl:45,spd:45,lck:30,def:30,res:15},items:['ironSword','vulnerary']},
fran:{name:'法蘭',classId:'mage',level:5,portrait:{hair:'#88f',eyes:'#f44',skin:'#fdb'},baseStats:{hp:18,str:1,mag:9,skl:6,spd:8,lck:4,def:2,res:6},growths:{hp:40,str:5,mag:65,skl:40,spd:45,lck:25,def:10,res:40},items:['fire','thunder']},
rex:{name:'雷克斯',classId:'wyvernRider',level:7,portrait:{hair:'#854',eyes:'#484',skin:'#dba'},baseStats:{hp:26,str:10,mag:0,skl:8,spd:7,lck:4,def:10,res:1},growths:{hp:60,str:45,mag:5,skl:35,spd:35,lck:20,def:40,res:10},items:['steelLance','javelin']},
morgane:{name:'莫爾甘',portrait:{hair:'#206',eyes:'#f0f',skin:'#baa'}}
};

function parseTerrain(terrainStrings,w,h){
const map=[];
const L={P:'plain',F:'forest',M:'mountain',W:'wall',G:'gate',R:'river',V:'village',I:'floor',T:'throne',L:'pillar'};
for(let y=0;y<h;y++){map[y]=[];const r=terrainStrings[y]||'';for(let x=0;x<w;x++)map[y][x]=L[r[x]]||'plain';}
return map;
}